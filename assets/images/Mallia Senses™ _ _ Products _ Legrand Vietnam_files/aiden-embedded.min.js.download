(function(){"use strict";function N(){const e="aiden-storage-test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}function A(){const e="aiden-storage-test";try{return sessionStorage.setItem(e,e),sessionStorage.removeItem(e),!0}catch{return!1}}const K=()=>A()?sessionStorage:E,D=()=>N()?localStorage:A()?sessionStorage:E,w={},E={getItem:e=>w[e]||null,setItem:(e,t)=>{w[e]=t},removeItem:e=>{delete w[e]}},v={session:K(),local:D()},u={};let h=[];function J(e,t){const n={type:"AdvisorSeen",userId:W(),path:window.location.pathname,domain:window.location.host,userAgent:navigator.userAgent,resolution:B(),screenSize:$()};fetch(`https://app.aiden.cx/webshop-api/v1/forms/website-analytics/${e}?&mode=${t}`,{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(n)})}function W(){const e=v.local.getItem("aidenUserId");if(!e){const t=window.crypto.getRandomValues(new Uint32Array(1))[0].toString();return v.local.setItem("aidenUserId",t),t}return e}function B(){return{width:screen.width||0,height:screen.height||0}}function $(){const e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0,t=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0;return{width:e,height:t}}function V(e){h=h.filter(t=>e.indexOf(t)>=0),e.forEach(t=>{if(h.indexOf(t)>=0)return;h.push(t);const n=G(t),o=X(t);if(!n)return;const a={rootMargin:"0px",threshold:o==="modal"?.9:.5};new IntersectionObserver(s=>{s.forEach(r=>{r.isIntersecting&&n&&!u[n]?u[n]=setTimeout(()=>{J(n,o),u[n]="sent"},3e3):!r.isIntersecting&&u[n]!=="sent"&&(clearTimeout(u[n]),u[n]=void 0)})},a).observe(t)})}function Y(e){return e instanceof HTMLElement&&(k(e)||P(e))}function k(e){return e instanceof HTMLIFrameElement&&e.tagName==="IFRAME"&&e.id&&e.id.startsWith("aiden-")&&L(e.id.replace("aiden-",""))}function P(e){return e.dataset&&"advisorId"in e.dataset&&L(e.dataset.advisorId||"")}function G(e){if(P(e))return e.dataset.advisorId;if(k(e))return e.id.replace("aiden-","")}function X(e){if(e instanceof HTMLIFrameElement){const t=new URLSearchParams(e.src);if(t.has("mode"))return t.get("mode")==="inpage"?"inpage":"banner"}return"modal"}function L(e){return RegExp(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-5][0-9a-f]{3}-[089ab][0-9a-f]{3}-[0-9a-f]{12}$/i).test(e)}function x(){const e=Array.from(document.querySelectorAll("iframe, [data-advisor-id]")).filter(t=>Y(t));V(e)}function M(){const e=(o,a)=>{a.disconnect();try{x(),M()}catch(i){console.error(i)}},t=new MutationObserver(e),n={attributes:!0,subtree:!0,childList:!0};t.observe(document.documentElement,n)}const O=v.local,T=btoa("aiden-storage"),U=e=>{const t=e.getItem(T)||"{}";return te(t)},Q=(e,t)=>{const n=e.data.sessionId,o=e.advisorId;if(n&&o&&Z.includes(e.type)){const a=U(t),i=a[o]||new Set,s=ee({...a,[o]:i.add(n)});t.setItem(T,s)}},Z=["answered-event","advised-event","completed-event","start-over-event","product-clicked-event","session-activity"];function C(e){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t,[...n]]))}function ee(e){return btoa(JSON.stringify(C(e)))}function te(e){try{const t=JSON.parse(atob(e));return t instanceof Object&&!(t instanceof Array)?Object.fromEntries(Object.entries(t).map(([n,o])=>o instanceof Array?[n,o.every(a=>typeof a=="string")?new Set(o):new Set]:[n,o])):{}}catch{return{}}}function ne(e){const t=["debug","apiKey","orderId","currency"],n=["aidenProductId","quantity","price"],o=(e.products||[]).map(i=>{if(typeof i=="object"&&!Array.isArray(i))return n.reduce((s,r)=>({...s,[r]:i[r]}),{})}).filter(function(i){return i!=null});return t.reduce((i,s)=>({...i,[s]:e[s]}),{products:o})}const oe=".aiden-lock-screen{overflow:hidden!important}.aiden-lock-screen.aiden-ios-lock{position:fixed;width:100%}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.aiden-modal{width:100%;height:100%;position:fixed;top:0;right:0;left:0;bottom:0;display:flex;pointer-events:all;z-index:2147483629;animation:fadeIn .5s ease-in;-webkit-overflow-scrolling:touch}.aiden-modal .aiden-modal-content{position:relative;z-index:2147483629;flex:1 1 auto;-webkit-overflow-scrolling:touch}.aiden-modal .aiden-modal-loading{position:absolute;left:0;top:0;height:100%;width:100%;align-items:center;display:flex;justify-content:center;background:#0000004d;color:#fff}.aiden-modal iframe{width:100%;height:100%;border:none}",p=window.navigator,b="aidenModal",I="aidenSidebar",g="aidenProductCheck";function S(e,t,n){const o="aiden-modal-"+e,a=document.querySelector(".aiden-modal"),s=(t==="sidebar"?[...n,["mode","sidebar"]]:n).map(([Re,_e])=>Re+"="+_e).join("&"),r=s?"&"+s:"";if(a&&a.id===o)return;a&&a.remove(),le(e,t,n);const d="https://app.aiden.cx/webshop/?advisorId="+e+r,c=document.createElement("div");c.id="aiden-modal-"+e;const y="<div class='aiden-modal-content'><style>"+oe+"</style><iframe id='aiden-modal-frame' allowtransparency='true' style='background-color:transparent;' src='"+d+"'>      </iframe>      <div id='aiden-modal-loading' class='aiden-modal-loading'>        <svg class='aiden-loading-icon' xmlns='http://www.w3.org/2000/svg' width='50' height='50' display='block' preserveAspectRatio='xMidYMid' viewBox='0 0 100 100'><style>.aiden-loading-icon{animation:rotate 1s linear infinite;}@keyframes rotate{from{transform: rotate(0deg);}to{transform: rotate(360deg);}</style><circle cx='50' cy='50' r='41' fill='none' stroke='currentColor' stroke-dasharray='193.208 66.403' stroke-width='10'></circle></svg>      </div>    </div>";c.className="aiden-modal",c.innerHTML=y.trim();const m=document.body;se(m),m.appendChild(c),ae(m);const f=document.getElementById("aiden-modal-frame"),j=document.getElementById("aiden-modal-loading");re()&&f&&(f.src=d),f&&f.addEventListener("load",function(){j&&(j.style.display="none")})}function ae(e){ie()&&e.classList.add("aiden-ios-lock")}function ie(){return/iPad|iPhone|iPod/.test(p.platform)||p.platform==="MacIntel"&&p.maxTouchPoints>1}function re(){return!p.userAgent.includes("Chrome")&&p.userAgent.includes("Safari")}function R(e){e.preventDefault(),e.stopPropagation()}function se(e){e.className+=" aiden-lock-screen",e.addEventListener("touchmove",R,{passive:!1})}function de(e){e.classList.remove("aiden-lock-screen"),e.removeEventListener("touchmove",R),e.classList.remove("aiden-ios-lock")}function ce(){const e=document.querySelector(".aiden-modal"),t=document.body;de(t),ue(),e&&e.remove()}function _(){const e=new URLSearchParams(window.location.search),t=new URL(window.location.href.replace(window.location.search,""));return e.delete(b),e.delete(I),{url:t,params:e}}function q(e,t){t.forEach((n,o)=>{e.searchParams.set(o,n)}),history.replaceState({},"",e.href)}function le(e,t,n){const{url:o,params:a}=_();a.set(t==="sidebar"?I:b,e),n.forEach(([i,s])=>{i==="productId"&&a.set(g,s),i==="productUrl"&&a.set(g,"")}),q(o,a)}function ue(){const{url:e,params:t}=_();t.delete(g),q(e,t)}function F(e){return new URLSearchParams(window.location.search).get(e)}function fe(){return F(b)}function pe(){return F(I)}function me(e){e.type==="background-click"&&ce()}const H=-100,he=e=>!!e&&typeof e=="object"&&"type"in e&&typeof e.type=="string",ge=e=>!!e&&typeof e=="object"&&"advisorId"in e&&typeof e.advisorId=="string",ye=e=>!!e&&typeof e=="object"&&"data"in e&&typeof e.data=="object",we=e=>ye(e)&&"height"in e.data&&typeof e.data.height=="number";function ve(e){const t=e.data;if(t&&he(t)&&ge(t)){const n=document.querySelector("iframe#aiden-"+t.advisorId)||be(e);if(!n||n.id==="aiden-modal-frame")return;if(t.type==="viewport-dimensions"&&we(t)&&(n.style.height=`${t.data.height+1}px`),t.type==="screen-change")try{const o=Ie(n),a=n.getBoundingClientRect().top+window.pageYOffset+o;window.scrollTo({top:a,behavior:"smooth"})}catch{}}}function be(e){const t=document.querySelectorAll("iframe");return Array.from(t).find(n=>{var o;return n.contentWindow===e.source||((o=n.contentDocument)==null?void 0:o.defaultView)===e.source})||null}function Ie(e){if(!e)return H;const t=e.dataset.scrolloffset||e.getAttribute("scrollOffset"),n=parseInt(t||"");return isFinite(n)?n:H}function Se(){return new Promise(e=>{if(document.body)e(document.body);else{const t=new MutationObserver(()=>{document.body&&(e(document.body),t.disconnect())});t.observe(document.documentElement,{childList:!0,subtree:!0})}})}function Ae(){try{x(),M()}catch(r){console.error(r)}Le();const e=document.querySelectorAll("[data-advisor-id]"),t=r=>{const d=r.getAttribute("data-product-check");return d===null?[]:d.trim()!==""?[["productId",d]]:[["productUrl",window.location.href.split("?")[0]]]},n=function(r){const d=r==null?void 0:r.target;if(d instanceof Element){const c=d.getAttribute("data-advisor-id")?d:d.closest("[data-advisor-id]"),y=c==null?void 0:c.getAttribute("data-advisor-id"),m=c?t(c):[],f=(c==null?void 0:c.getAttribute("data-aiden-mode"))==="sidebar"?"sidebar":"modal";y&&S(y,f,m)}},o=fe(),a=pe(),i=a?"sidebar":"modal",s=o||a;s&&Se().then(()=>{S(s,i,xe())}),e.forEach(function(r){r.addEventListener("click",n)}),window.addEventListener("click",n),window.addEventListener("message",r=>{if(Ee(r.data)){const d=r.data;me(d),ve(r),ke(d)&&Q(d,O)}}),Pe()}const Ee=e=>e!==null&&typeof e=="object"&&!(e instanceof Array)&&"data"in e&&"advisorId"in e&&"type"in e,ke=e=>"sessionId"in e.data&&typeof e.data.sessionId=="string",Pe=()=>{const e=document.getElementsByTagName("IFRAME");Array.from(e).forEach(t=>{t instanceof HTMLIFrameElement&&t.id.startsWith("aiden-")&&t.contentWindow&&t.contentWindow.window.postMessage({type:"init"},"*")})};function Le(){try{typeof Element<"u"&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(e){var t=this;if(!t)return null;do{if(t.matches(e))return t;t=t.parentElement||t.parentNode}while(t!==null&&t.nodeType===1);return null}))}catch{}}window._aidenApp={openAdvisor:S};function xe(){const t=new URLSearchParams(window.location.search).get(g);return t===null?[]:t.trim()!==""?[["productId",t]]:[["productUrl",window.location.href.split("?")[0]]]}function Me(){window.addEventListener("message",function(e){var n,o,a,i;const t=(n=e.data)==null?void 0:n.eventData;((o=e.data)==null?void 0:o.integration)==="aiden:google_tag_manager"&&typeof((a=e.data)==null?void 0:a.type)=="string"&&t&&(window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:(i=e.data)==null?void 0:i.type,...t}))})}function Oe(){window.addEventListener("message",function(e){var n,o,a,i;const t=(n=e.data)==null?void 0:n.eventData;((o=e.data)==null?void 0:o.integration)==="aiden:google_analytics"&&typeof((a=e.data)==null?void 0:a.type)=="string"&&t&&(typeof gtag=="function"?gtag("event",(i=e.data)==null?void 0:i.type,t):setTimeout(()=>{var s;typeof gtag=="function"&&gtag("event",(s=e.data)==null?void 0:s.type,t)},2e3))})}function Te(){window._sqzl=window._sqzl||[],window.addEventListener("message",function(e){var n,o;const t=(n=e.data)==null?void 0:n.eventData;((o=e.data)==null?void 0:o.integration)==="aiden:squeezely"&&t&&window._sqzl.push(t)})}function Ue(){window.addEventListener("message",function(e){var n,o,a;const t=(n=e.data)==null?void 0:n.eventData;((o=e.data)==null?void 0:o.integration)==="aiden:bloomreach"&&typeof((a=e.data)==null?void 0:a.type)=="string"&&t&&(window.exponea?window.exponea.track(e.data.type,t):setTimeout(()=>{window.exponea&&window.exponea.track(e.data.type,t)},2e3))})}function l(e,t=void 0){console.group("Aiden"),t?console.error(e,t):console.error(e),console.groupEnd()}function z(e){const t=C(U(O));try{if(!(typeof e=="object"&&!Array.isArray(e))){l("purchase event provided was not a correctly formed object");return}if(typeof e=="object"&&"apiKey"in e&&typeof e.apiKey=="string"){const n=new XMLHttpRequest,o=e.apiKey;n.open("POST","https://app.aiden.cx/webshop-api/v1/purchase",!0),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Accept","application/json, text/plain, */*"),n.responseType="text",n.setRequestHeader("X-API-KEY",o),n.send(JSON.stringify({...ne(e),sessions:t})),n.onloadend=()=>{n.status===200&&(e!=null&&e.debug)&&(console.group("Aiden"),console.info("Purchase event sent succesfully"),console.groupEnd()),(n.status===400||n.status===422)&&l("There was something wrong when sending the purchase event",JSON.parse(n.responseText)),n.status===403&&l("The API key you have provided is invalid.")}}else l("An API key was not provided for the purchase event. Include an 'apiKey' key and provide the key which starts with 'AID-'");return}catch(n){l("",n);return}}function Ce(e){e._aiden||(e._aiden=[]);try{if(e._aiden.push=function(n){return typeof n=="object"&&"event"in n&&typeof n.event=="string"&&(n.event.toLowerCase()==="purchase"?z(n):l("Unknown event type: "+n.event)),1},e._aiden&&Array.isArray(e._aiden)){for(var t=0;t<e._aiden.length;t++)z(e._aiden[t]);e._aiden.length=0}}catch{l("Failed to send purchase event");return}}Ce(window),Ae(),Te(),Ue(),Me(),Oe()})();
